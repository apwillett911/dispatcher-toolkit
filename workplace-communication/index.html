<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EI Snapshot — Dispatcher Toolkit</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .strike-soft { text-decoration: line-through; text-decoration-thickness: 0.08em; text-decoration-color: rgba(100,116,139,.6); }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
  <main class="max-w-3xl mx-auto px-4 py-10">
    <a href="../index.html" class="text-blue-600 underline">&larr; Back to Home</a>

    <h1 class="mt-4 text-2xl font-bold">EI Snapshot</h1>
    <p class="mt-2 text-slate-600">
      Emotional intelligence matters in a 9-1-1 center. Calls arrive hot; emotions run higher than facts; and teamwork
      is the air you breathe. Strong EI helps you steady yourself, hear what isn’t said, defuse escalation, and keep the
      hand-offs clean. Take this 60-second pulse and get one concrete practice for your next shift.
    </p>

    <!-- Quiz -->
    <section class="mt-6 bg-white rounded-2xl border border-slate-200 shadow">
      <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold">6 quick items</h2>
        <span class="text-xs text-slate-500">Rate 1–5 (1 = rarely, 5 = consistently)</span>
      </div>

      <div id="quiz" class="p-5 space-y-5"><!-- rows injected --></div>

      <div class="px-5 pb-5 flex flex-wrap gap-2 items-center">
        <button id="submitBtn" type="button" class="bg-blue-600 text-white px-3 py-1.5 rounded-md text-sm hover:bg-blue-700">Show Snapshot</button>
        <button id="resetBtn" type="button" class="bg-slate-200 text-slate-800 px-3 py-1.5 rounded-md text-sm hover:bg-slate-300">Reset</button>
        <span id="incompleteNote" class="text-xs text-rose-600 hidden">Please answer all items.</span>
      </div>
    </section>

    <!-- Results -->
    <section id="results" class="mt-6 bg-white rounded-2xl border border-slate-200 shadow hidden">
      <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold">Your EI Snapshot</h2>
        <span id="savedTag" class="hidden rounded-full px-2 py-0.5 text-xs border border-emerald-600 text-emerald-800 bg-emerald-50">Saved</span>
      </div>

      <div class="p-5">
        <h3 class="font-semibold">Strengths</h3>
        <ul id="strengths" class="mt-2 list-disc ml-5 text-sm text-slate-800 space-y-1"></ul>

        <div class="mt-5">
          <h3 class="font-semibold">One practice for your next shift</h3>
          <p id="practice" class="mt-2 text-sm text-slate-700"></p>
          <div class="mt-3 flex gap-2 items-center">
            <button id="copyBtn" type="button" class="bg-blue-600 text-white px-3 py-1.5 rounded-md text-sm hover:bg-blue-700">Copy</button>
            <span id="copied" class="text-xs text-green-600 hidden">Copied!</span>
          </div>
        </div>

        <div class="mt-5 text-xs text-slate-500">
          Tip: Rotate practices across shifts to build range. You can reset and retake anytime.
        </div>
      </div>
    </section>
  </main>

  <script>
    const STORAGE_KEY = 'dt_wc_ei_snapshot_v2';

    const ITEMS = [
      { id: 'self_awareness',       facet: 'Self-Awareness',        text: 'When I feel flooded on a call, I notice it quickly and name it (e.g., “I’m getting amped”).' },
      { id: 'self_regulation',      facet: 'Self-Regulation',       text: 'Under pressure, I slow my speech and hit the policy beats instead of speeding up or skipping steps.' },
      { id: 'empathy',              facet: 'Empathy',               text: 'I can reflect a caller’s emotion (fear/anger/confusion) in one short phrase without taking it on.' },
      { id: 'listening',            facet: 'Listening',             text: 'I paraphrase and confirm the actionable detail (“So you’re on SE 82nd & Stark?”) before moving on.' },
      { id: 'team_skills',          facet: 'Team Skills',           text: 'I keep net hand-offs short (what, where, status) and avoid side-talk that muddies the channel.' },
      { id: 'situational_awareness',facet: 'Situational Awareness', text: 'I notice early signs that the room’s stress is rising (tone, posture, mistakes) and take steps to steady myself and the team.' }
    ];

    const PRACTICES = {
      'Self-Awareness':        'Before each high-stakes call, do a 3-second check: “Body? Breath? Bias?” Relax jaw, exhale once, and name any impulse.',
      'Self-Regulation':       'Use a cadence cue: short sentences + one beat of silence before the next instruction. It slows you and calms the caller.',
      'Empathy':               'Add one emotion label per call: “I hear you’re scared—stay with me.” Keep it 6–8 words, then pivot to action.',
      'Listening':             'Paraphrase location first, then repeat the most critical noun/verb. Example: “SE 82nd & Stark — you’re seeing smoke, not flames?”',
      'Team Skills':           'At hand-off, use the 3-beat: WHAT (call type), WHERE (verified), STATUS (units/risks). No extras.',
      'Situational Awareness': 'Every 20 minutes, scan the room: volume, speed, error rate. If rising, suggest a 30-second reset or rotate tasks.'
    };

    const quizEl = document.getElementById('quiz');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn  = document.getElementById('resetBtn');
    const resultsEl = document.getElementById('results');
    const strengthsEl = document.getElementById('strengths');
    const practiceEl  = document.getElementById('practice');
    const savedTag    = document.getElementById('savedTag');
    const incompleteNote = document.getElementById('incompleteNote');
    const copyBtn     = document.getElementById('copyBtn');
    const copiedNote  = document.getElementById('copied');

    // load/save
    const loadSaved = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null; } catch { return null; } };
    const saveSaved = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    const clearSaved = () => localStorage.removeItem(STORAGE_KEY);

    // state
    let scores = {};         // id -> 1..5
    let activeRowIndex = 0;  // for keyboard input

    // build rows
    ITEMS.forEach((item, idx) => {
      const row = document.createElement('div');
      row.className = 'bg-white rounded-xl border border-slate-200 p-4 outline-none';
      row.tabIndex = 0; // focusable for keyboard 1-5
      row.dataset.index = idx;

      row.innerHTML = `
        <div class="flex items-start justify-between gap-4">
          <div class="cursor-pointer select-none">
            <div class="text-sm text-slate-500">${idx+1}/6 • ${item.facet}</div>
            <div class="mt-1 font-medium">${item.text}</div>
          </div>
          <div class="shrink-0">
            <div class="flex gap-1" role="group" aria-label="Rate ${item.facet}">
              ${[1,2,3,4,5].map(n => `
                <button type="button"
                        class="score-btn border border-slate-200 bg-white hover:bg-slate-50 rounded-md px-3 py-1.5 text-sm"
                        data-id="${item.id}" data-facet="${item.facet}" data-score="${n}" aria-pressed="false">${n}</button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      quizEl.appendChild(row);

      // remember which row is active when focused/clicked
      row.addEventListener('focus', () => { activeRowIndex = idx; });
      row.addEventListener('click', () => { activeRowIndex = idx; });

      // wire buttons now (they exist inside row)
      row.querySelectorAll('.score-btn').forEach(btn => {
        btn.addEventListener('click', () => selectScore(item.id, item.facet, Number(btn.dataset.score), row));
      });
    });

    // restore if saved
    const saved = loadSaved();
    if (saved?.answers) {
      scores = saved.answers;
      // paint selections
      ITEMS.forEach((item, idx) => {
        const row = quizEl.querySelector(`div[data-index="${idx}"]`);
        paintRowSelection(row, item.id, scores[item.id]);
      });
      if (saved.results) {
        showResults(saved.results, true);
      }
    }

    // selection logic
    function selectScore(id, facet, value, rowEl) {
      scores[id] = value;
      paintRowSelection(rowEl, id, value);
    }

    function paintRowSelection(rowEl, id, value) {
      const btns = rowEl.querySelectorAll(`.score-btn[data-id="${id}"]`);
      btns.forEach(b => {
        const isOn = Number(b.dataset.score) === Number(value);
        b.setAttribute('aria-pressed', isOn ? 'true' : 'false');
        b.className = isOn
          ? 'score-btn border-2 border-blue-600 bg-blue-50 text-blue-800 rounded-md px-3 py-1.5 text-sm'
          : 'score-btn border border-slate-200 bg-white hover:bg-slate-50 rounded-md px-3 py-1.5 text-sm';
      });
    }

    // compute + show
    submitBtn.addEventListener('click', () => {
      const complete = ITEMS.every(i => Number.isInteger(scores[i.id]));
      if (!complete) { incompleteNote.classList.remove('hidden'); return; }
      incompleteNote.classList.add('hidden');

      const byFacet = {};
      ITEMS.forEach(i => { byFacet[i.facet] = (byFacet[i.facet] || 0) + (scores[i.id] || 0); });

      const sorted = Object.entries(byFacet).sort((a,b) => b[1]-a[1]);
      const strengths = sorted.slice(0,2).map(([f]) => f);
      const lowest = sorted[sorted.length-1][0];
      const practice = PRACTICES[lowest];

      const results = { strengths, lowest, practice, byFacet };
      showResults(results, false);
      saveSaved({ answers: scores, results });
    });

    function showResults(results, fromStorage) {
      strengthsEl.innerHTML = '';
      results.strengths.forEach(f => {
        const li = document.createElement('li');
        li.textContent = f;
        strengthsEl.appendChild(li);
      });
      practiceEl.textContent = results.practice;
      resultsEl.classList.remove('hidden');
      savedTag.classList.toggle('hidden', !fromStorage);
    }

    // copy / reset
    copyBtn?.addEventListener('click', async () => {
      const saved = loadSaved();
      if (!saved?.results) return;
      const text = [
        'EI Snapshot — Dispatcher Toolkit',
        `Strengths: ${saved.results.strengths.join(', ')}`,
        `Practice for next shift: ${saved.results.practice}`
      ].join('\n');
      try {
        await navigator.clipboard.writeText(text);
        copiedNote.classList.remove('hidden');
        setTimeout(()=>copiedNote.classList.add('hidden'), 1400);
      } catch { alert('Could not copy.'); }
    });

    resetBtn.addEventListener('click', () => {
      scores = {};
      clearSaved();
      // clear UI
      ITEMS.forEach((item, idx) => {
        const row = quizEl.querySelector(`div[data-index="${idx}"]`);
        paintRowSelection(row, item.id, null);
      });
      resultsEl.classList.add('hidden');
      incompleteNote.classList.add('hidden');
    });

    // keyboard 1–5 on the focused row
    document.addEventListener('keydown', (e) => {
      if (!/^[1-5]$/.test(e.key)) return;
      const idx = activeRowIndex;
      const item = ITEMS[idx];
      const row = quizEl.querySelector(`div[data-index="${idx}"]`);
      selectScore(item.id, item.facet, Number(e.key), row);
    });
  </script>
</body>
</html>
